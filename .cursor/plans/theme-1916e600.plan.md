<!-- 1916e600-ac43-4f7c-a9e9-e0337a48acd7 4cc73501-145d-411f-b670-f4eca2af4a21 -->
# Parallel Playbook and Plan Generation

## Goal

Optimize plan generation by running playbook creation and plan generation in parallel, using initial responses directly for plan generation instead of waiting for the playbook.

## Current Flow

1. Format initial responses
2. Store initial responses
3. Extract lessons from onboarding (blocking)
4. Process through Curator (blocking)
5. Store playbook (blocking)
6. Generate plan using playbook (blocking)
7. Save plan

## New Flow

1. Format initial responses
2. Store initial responses
3. **Run in parallel:**

- Task A: Extract lessons → Curate → Enrich → Store playbook (async, non-blocking)
- Task B: Generate plan using formatted_initial_responses directly (blocking for response)

4. Save plan

## Implementation Steps

### 1. Modify `generate_initial_training_plan` method

**File:** `backend/core/training/training_coach.py`

- Change signature to accept `formatted_initial_responses: str` and `initial_questions: List[AIQuestion]` instead of `user_playbook`
- Update `_decide_modalities` call to pass `formatted_initial_responses` instead of `user_playbook`
- Update prompt generation to use `formatted_initial_responses` instead of `user_playbook`

### 2. Modify `_decide_modalities` method

**File:** `backend/core/training/training_coach.py`

- Change signature to accept `formatted_initial_responses: str` instead of `user_playbook`
- Update `generate_modality_selection_prompt` call to pass responses instead of playbook
- Modify prompt generator to handle responses format

### 3. Modify prompt generator methods

**File:** `backend/core/training/helpers/prompt_generator.py`

- Update `generate_modality_selection_prompt` to accept `formatted_initial_responses: str` instead of `user_playbook`
- Update `generate_initial_training_plan_prompt` to accept `formatted_initial_responses: str` and `initial_questions: List[AIQuestion]` instead of `user_playbook`
- Replace `format_playbook_lessons` call with a new method that formats initial responses as onboarding context
- Create new helper method `format_onboarding_responses` that formats Q&A responses for prompt inclusion (similar structure to playbook but from raw responses)

### 4. Refactor API endpoint for parallel execution

**File:** `backend/core/training/training_api.py`

- After formatting responses and storing them, create two async tasks:
- Task A: Playbook generation (extract → curate → enrich → store)
- Task B: Plan generation (using formatted_initial_responses)
- Use `asyncio.gather` or `asyncio.create_task` to run both in parallel
- Wait for plan generation to complete (for API response)
- Store playbook asynchronously (fire-and-forget or await after plan response)

### 5. Update method signatures and calls

- Update all calls to `generate_initial_training_plan` to pass `formatted_initial_responses` and `initial_questions`
- Ensure `save_training_plan` still receives playbook if available (may be None during parallel execution)

## Key Changes Summary

**training_coach.py:**

- `generate_initial_training_plan`: Accept `formatted_initial_responses` + `initial_questions` instead of `user_playbook`
- `_decide_modalities`: Accept `formatted_initial_responses` instead of `user_playbook`

**prompt_generator.py:**

- `generate_modality_selection_prompt`: Accept `formatted_initial_responses` instead of `user_playbook`
- `generate_initial_training_plan_prompt`: Accept `formatted_initial_responses` + `initial_questions` instead of `user_playbook`
- Add `format_onboarding_responses`: Format Q&A responses for prompt (replaces playbook section)

**training_api.py:**

- Refactor `/generate-plan` endpoint to run playbook generation and plan generation in parallel
- Use `asyncio.create_task` for playbook generation (non-blocking)
- Use `await` for plan generation (blocking for response)

## Benefits

- Significant time savings: Plan generation no longer waits for playbook extraction, curation, and enrichment
- Better user experience: Faster plan generation response
- Playbook still created and stored for future use (week updates, etc.)