<!-- 9ef54084-c0f0-4861-bdcb-965a51e3cb32 c06bc3b9-1a70-4bd6-af95-aec57e1d1ae0 -->
# Unified LLM Refactor Plan

## Package Recommendation: Instructor

**Selected Package**: Instructor (https://python.useinstructor.com/)

### Pros:

- **Pydantic-native**: Built specifically for Pydantic structured output
- **Unified schemas**: Single Pydantic model works across OpenAI, Gemini, Claude, Anthropic, Cohere
- **Provider abstraction**: Handles provider-specific differences automatically
- **Agentic-ready**: Can be integrated with LangGraph/LangChain later

## Critical Schema Requirement: Literal Types (NOT Enums)

**Problem**: Gemini rejects JSON Schema with `$ref`/`allOf` generated by Pydantic Enums. This causes errors at generation time.

**Solution**: Use **Literal types** for all constrained string fields. Literal types generate JSON Schema with inline `enum` constraints that:

- Work for ALL providers (OpenAI, Gemini, Claude)
- Force LLM to only use valid values at generation time
- Require NO post-validation (schema enforces constraints)

**Approach**:

1. Keep Enum classes for Python type hints and database validation
2. Create Literal types from Enum values dynamically
3. Use Literal types in unified schemas (not Enums)
4. Convert Literal values back to Enums when storing in database

## Implementation Steps

### 1. Install Instructor Package

- Add `instructor` to `requirements.txt` (latest version)
- Verify compatibility with Pydantic v2.10.6

### 2. Create Literal Type Helpers

- **File**: `backend/core/training/schemas/training_schemas.py`
- Extend `_create_literal_from_values()` to handle all Enums
- Create Literal types for ALL Enums:
- `EquipmentLiteral` (already exists)
- `MainMuscleLiteral` (already exists)
- `QuestionTypeLiteral` from `QuestionType` enum
- `DayOfWeekLiteral` from `DayOfWeek` enum
- `TrainingTypeLiteral` from `TrainingType` enum
- `EnduranceTypeLiteral` from `EnduranceType` enum
- `VolumeUnitLiteral` from `VolumeUnit` enum
- `FeedbackIntentLiteral` from `FeedbackIntent` enum
- `FeedbackActionLiteral` from `FeedbackAction` enum
- `OperationTypeLiteral` from `OperationType` enum
- `AthleteTypeLiteral` from `AthleteType` enum
- `IntentPlanPriorityLiteral` from `IntentPlanPriority` enum

### 3. Update Unified Schemas to Use Literal Types

- **Files**: 
- `backend/core/training/schemas/training_schemas.py`
- `backend/core/training/schemas/question_schemas.py`
- Replace Enum fields with Literal types:
- `AIStrengthExercise.main_muscle`: `MainMuscleEnum` → `MainMuscleLiteral`
- `AIStrengthExercise.equipment`: `EquipmentEnum` → `EquipmentLiteral`
- `AIQuestion.response_type`: `QuestionType` → `QuestionTypeLiteral`
- `DailyTraining.day_of_week`: `DayOfWeek` → `DayOfWeekLiteral`
- `DailyTraining.training_type`: `TrainingType` → `TrainingTypeLiteral`
- `EnduranceSession.sport_type`: `EnduranceType` → `EnduranceTypeLiteral`
- `EnduranceSession.unit`: `VolumeUnit` → `VolumeUnitLiteral`
- `FeedbackIntentClassification.intent`: `FeedbackIntent` → `FeedbackIntentLiteral`
- `FeedbackIntentClassification.action`: `FeedbackAction` → `FeedbackActionLiteral`
- `PlanOperation.type`: `OperationType` → `OperationTypeLiteral`
- `AthleteTypeClassification.primary_type`: `AthleteType` → `AthleteTypeLiteral`
- `AthleteTypeClassification.secondary_types`: `List[AthleteType]` → `List[AthleteTypeLiteral]`
- `IntentPlanItem.priority`: `IntentPlanPriority` → `IntentPlanPriorityLiteral`
- Add helper methods to convert Literal values to Enums (for database storage)
- **Delete ALL Gemini* schema classes** (no longer needed)

### 4. Create Unified LLM Client with Instructor

- **File**: `backend/core/training/helpers/llm_client.py` (complete refactor)
- Initialize Instructor clients for each provider (OpenAI, Gemini, Claude)
- Two model instances: `complex_model` and `lightweight_model` (from env vars)
- Unified `parse_structured(prompt, schema, model_type="complex"|"lightweight")` method
- Auto-detect provider from model name and route to correct Instructor client
- Remove all provider-specific logic

### 5. Update TrainingCoach

- **File**: `backend/core/training/training_coach.py`
- Remove all `if self.llm.provider == "gemini"` conditionals
- Replace `self.llm.parse_structured(prompt, openai_schema, gemini_schema)` with unified calls
- **Complex model** (for plan creation/updates):
- `generate_initial_training_plan()`
- `update_weekly_schedule()`
- `create_new_weekly_schedule()`
- **Lightweight model** (for everything else):
- `generate_initial_questions()`
- `_decide_modalities()`
- `classify_feedback_intent_lightweight()`
- `_generate_future_week_outlines()`
- All other operations
- Remove `_normalize_gemini_training_plan_input()` method and calls
- Update all schema references to use unified schemas with Literal types

### 6. Update Other Components

- **Files**:
- `backend/core/base/reflector.py`
- `backend/core/base/curator.py`
- Migrate to unified client interface
- Remove provider-specific logic

### 7. Environment Configuration

- **File**: `backend/env.template`
- Add env vars:
- `LLM_MODEL_COMPLEX` (e.g., `gpt-4o`, `gemini-2.0-flash-exp`)
- `LLM_MODEL_LIGHTWEIGHT` (e.g., `gpt-4o-mini`, `gemini-1.5-flash`)
- Keep `LLM_API_KEY` and `TEMPERATURE`

### 8. Testing & Validation

- **Critical**: Verify Literal types generate JSON Schema with inline `enum` constraints (no `$ref`/`allOf`)
- Test with OpenAI, Gemini, Claude - verify only valid values returned
- Verify LLM cannot generate invalid values (test rejection)
- Test Enum conversion from Literal values (for database)
- Verify no provider-specific code paths remain

## Files to Modify

- `backend/core/training/schemas/training_schemas.py` - Add Literal types, update schemas, delete Gemini schemas
- `backend/core/training/schemas/question_schemas.py` - Add Literal types, update schemas, delete Gemini schemas
- `backend/core/training/helpers/llm_client.py` - Complete refactor with Instructor
- `backend/core/training/training_coach.py` - Remove provider conditionals, use unified schemas
- `backend/core/base/reflector.py` - Update LLM usage
- `backend/core/base/curator.py` - Update LLM usage
- `backend/requirements.txt` - Add instructor package
- `backend/env.template` - Add model configuration vars